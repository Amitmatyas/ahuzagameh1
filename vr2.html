<!doctype html>
<html lang="he" dir="rtl">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×¨×•×¥ ×”××©×™××•×ª</title>
  <style>
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      overflow-x: hidden;
    }

    html, body {
      height: 100%;
    }

    * {
      box-sizing: border-box;
    }

    /* ××¡×š ×›× ×™×¡×” */
    .login-screen {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100%;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    /* ×× ×™××¦×™×•×ª ×¨×§×¢ */
    .background-animation {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: 0;
      overflow: hidden;
    }

    .circle {
      position: absolute;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      animation: float 6s ease-in-out infinite;
    }

    .circle:nth-child(1) {
      width: 80px;
      height: 80px;
      top: 10%;
      left: 10%;
      animation-delay: 0s;
    }

    .circle:nth-child(2) {
      width: 120px;
      height: 120px;
      top: 60%;
      left: 80%;
      animation-delay: 2s;
    }

    .circle:nth-child(3) {
      width: 60px;
      height: 60px;
      top: 80%;
      left: 20%;
      animation-delay: 4s;
    }

    .circle:nth-child(4) {
      width: 100px;
      height: 100px;
      top: 20%;
      left: 75%;
      animation-delay: 1s;
    }

    @keyframes float {
      0%, 100% {
        transform: translateY(0) scale(1);
        opacity: 0.3;
      }
      50% {
        transform: translateY(-30px) scale(1.1);
        opacity: 0.5;
      }
    }

    /* ×›×¨×˜×™×¡ ×›× ×™×¡×” */
    .login-card {
      background: white;
      border-radius: 20px;
      padding: 50px 40px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      text-align: center;
      max-width: 400px;
      width: 100%;
      position: relative;
      z-index: 1;
      animation: slideUp 0.8s ease-out;
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(50px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .logo-container {
      margin-bottom: 30px;
      animation: bounce 1s ease-in-out 0.5s;
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .logo {
      font-size: 64px;
      animation: rotate 3s ease-in-out infinite;
    }

    @keyframes rotate {
      0%, 100% {
        transform: rotate(0deg);
      }
      50% {
        transform: rotate(10deg);
      }
    }

    .app-title {
      font-size: 32px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      animation: fadeIn 1s ease-in 0.3s both;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    .welcome-text {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      animation: fadeIn 1s ease-in 0.5s both;
    }

    .password-container {
      margin-bottom: 20px;
      animation: fadeIn 1s ease-in 0.7s both;
    }

    .password-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    .password-input:focus {
      outline: none;
      border-color: #667eea;
    }

    .login-button {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      animation: fadeIn 1s ease-in 0.9s both;
    }

    .login-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .login-button:active {
      transform: translateY(0);
    }

    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 10px;
      display: none;
    }

    /* ××¡×š ×¨××©×™ */
    .main-screen {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 30px;
      text-align: center;
    }

    .header h1 {
      color: #667eea;
      margin: 0;
      font-size: 32px;
    }

    .main-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .main-button {
      background: white;
      padding: 40px 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      text-align: center;
    }

    .main-button:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
    }

    .main-button-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }

    .main-button-text {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    /* ××¡×›×™× ××©× ×™×™× */
    .secondary-screen {
      display: none;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .back-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      margin-bottom: 20px;
      transition: background 0.2s;
    }

    .back-button:hover {
      background: #5568d3;
    }

    .section-title {
      font-size: 28px;
      font-weight: bold;
      color: white;
      margin-bottom: 20px;
    }

    .content-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .form-input, .form-textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    .form-input:focus, .form-textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .action-button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s;
      margin-left: 10px;
    }

    .action-button:hover {
      background: #5568d3;
    }

    .action-button.secondary {
      background: #95a5a6;
    }

    .action-button.secondary:hover {
      background: #7f8c8d;
    }

    .list-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .list-item-content {
      flex: 1;
    }

    .list-item-title {
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }

    .list-item-desc {
      color: #666;
      font-size: 14px;
    }

    .delete-button {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .delete-button:hover {
      background: #c0392b;
    }

    .empty-state {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .teams-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .team-card {
      background: #f0f0f0;
      padding: 15px;
      border-radius: 8px;
    }

    .team-name {
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }

    .team-members {
      font-size: 14px;
      color: #666;
    }

    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #333;
      color: white;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      display: none;
      z-index: 1000;
    }

    .toast.show {
      display: block;
      animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .login-card {
        padding: 40px 30px;
      }

      .app-title {
        font-size: 28px;
      }

      .main-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
 </head>
 <body>
  <!-- ×¨×§×¢ ×× ×™××¦×™×” -->
  <div class="background-animation">
   <div class="circle"></div>
   <div class="circle"></div>
   <div class="circle"></div>
   <div class="circle"></div>
  </div>

  <!-- ××¡×š ×›× ×™×¡×” -->
  <div class="login-screen" id="loginScreen">
   <div class="login-card">
    <div class="logo-container">
     <div class="logo">ğŸ†</div>
    </div>
    <h1 class="app-title">××™×¨×•×¥ ×”××©×™××•×ª</h1>
    <p class="welcome-text">×‘×¨×•×›×™× ×”×‘××™× ×œ××™×¨×•×¥ ×”××©×™××•×ª!</p>
    <div class="password-container">
      <label for="passwordInput" class="form-label">×”×–×Ÿ ×¡×™×¡××”:</label>
      <input type="password" id="passwordInput" class="password-input" placeholder="×¡×™×¡××”">
    </div>
    <button class="login-button" id="loginButton">×›× ×™×¡×”</button>
    <div class="error-message" id="errorMessage">×¡×™×¡××” ×©×’×•×™×”, × ×¡×” ×©×•×‘</div>
   </div>
  </div>

  <!-- ××¡×š ×¨××©×™ -->
  <div class="main-screen" id="mainScreen">
   <div class="header">
    <h1>××™×¨×•×¥ ×”××©×™××•×ª</h1>
   </div>
   <div class="main-buttons">
    <div class="main-button" id="newGameBtn">
     <div class="main-button-icon">ğŸ®</div>
     <div class="main-button-text">××©×—×§ ×—×“×©</div>
    </div>
    <div class="main-button" id="previousGamesBtn">
     <div class="main-button-icon">ğŸ“‹</div>
     <div class="main-button-text">××©×—×§ ×§×•×“×</div>
    </div>
    <div class="main-button" id="settingsBtn">
     <div class="main-button-icon">âš™ï¸</div>
     <div class="main-button-text">×”×’×“×¨×•×ª</div>
    </div>
   </div>
  </div>

  <!-- ××¡×š ××©×—×§ ×—×“×© -->
  <div class="secondary-screen" id="newGameScreen">
    <button class="back-button" id="backFromNewGame">â† ×—×–×•×¨</button>
    <h2 class="section-title">××©×—×§ ×—×“×©</h2>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×‘×—×¨ ×—×œ×•×§×ª ×§×‘×•×¦×•×ª</h3>
      <div id="selectGroupForGame"></div>
      <button class="action-button" id="startGameBtn" style="margin-top: 20px;" disabled>×”×ª×—×œ ××©×—×§</button>
    </div>
  </div>

  <!-- ××¡×š ×œ×•×— ××—×•×•× ×™× -->
  <div class="secondary-screen" id="dashboardScreen">
    <button class="back-button" id="backFromDashboard">â† ×—×–×•×¨</button>
    <h2 class="section-title" id="dashboardTitle">×œ×•×— ××—×•×•× ×™×</h2>
    <div class="content-card">
      <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;">
        <button class="action-button" id="selectTaskBtn">×‘×—×¨ ××©×™××”</button>
        <button class="action-button secondary" id="showResultsBtn">×”×¦×’ ×ª×•×¦××•×ª</button>
        <button class="action-button secondary" id="showGroupDashBtn">×”×¦×’ ×—×œ×•×§×”</button>
        <button class="action-button secondary" id="showPrevTasksBtn">×”×¦×’ ××©×™××•×ª ×§×•×“××•×ª</button>
      </div>
      <div id="dashboardContent" style="text-align: center; padding: 40px; color: #666;">
        ×œ×—×¥ ×¢×œ "×‘×—×¨ ××©×™××”" ×œ×”×ª×—×œ×ª ××©×™××” ×—×“×©×”
      </div>
    </div>
  </div>

  <!-- ××¡×š ×‘×—×™×¨×ª ××©×™××” -->
  <div class="secondary-screen" id="selectTaskScreen">
    <button class="back-button" id="backFromSelectTask">â† ×—×–×•×¨</button>
    <h2 class="section-title">×‘×—×¨ ××©×™××”</h2>
    <div class="content-card">
      <div id="tasksForSelection"></div>
    </div>
  </div>

  <!-- ××¡×š ×‘×™×¦×•×¢ ××©×™××” -->
  <div class="secondary-screen" id="taskExecutionScreen">
    <button class="back-button" id="backFromTaskExecution">â† ×—×–×•×¨</button>
    <h2 class="section-title" id="taskExecTitle">××©×™××”</h2>
    <div class="content-card">
      <div id="taskDetails" style="margin-bottom: 30px;"></div>
      <div id="timerSection"></div>
    </div>
  </div>

  <!-- ××¡×š ×ª×•×¦××•×ª -->
  <div class="secondary-screen" id="resultsScreen">
    <button class="back-button" id="backFromResults">â† ×—×–×•×¨</button>
    <h2 class="section-title">×ª×•×¦××•×ª ×”××©×—×§</h2>
    <div class="content-card">
      <div id="resultsContent"></div>
    </div>
  </div>

  <!-- ××¡×š ××©×™××•×ª ×§×•×“××•×ª -->
  <div class="secondary-screen" id="prevTasksScreen">
    <button class="back-button" id="backFromPrevTasks">â† ×—×–×•×¨</button>
    <h2 class="section-title">××©×™××•×ª ×§×•×“××•×ª</h2>
    <div class="content-card">
      <div id="prevTasksContent"></div>
    </div>
  </div>

  <!-- ××¡×š ××©×—×§×™× ×§×•×“××™× -->
  <div class="secondary-screen" id="previousGamesScreen">
    <button class="back-button" id="backFromPreviousGames">â† ×—×–×•×¨</button>
    <h2 class="section-title">××©×—×§×™× ×§×•×“××™×</h2>
    <div class="content-card">
      <div id="previousGamesList"></div>
    </div>
  </div>

  <!-- ×—×œ×•×Ÿ ×¦×£ ×”×¦×’×ª ×—×œ×•×§×” -->
  <div id="groupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
   <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
    <h3 style="color: #667eea; margin-bottom: 20px;">×”×—×œ×•×§×” ×”× ×•×›×—×™×ª</h3>
    <div id="groupModalContent"></div>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="action-button" id="changeGroupBtn">×©× ×” ×—×œ×•×§×”</button>
      <button class="action-button secondary" id="closeGroupModal">×¡×’×•×¨</button>
    </div>
   </div>
  </div>

  <!-- ×—×œ×•×Ÿ ×¦×£ ×©×™× ×•×™ ×—×œ×•×§×” -->
  <div id="changeGroupModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; align-items: center; justify-content: center;">
   <div style="background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 80%; overflow-y: auto;">
    <h3 style="color: #667eea; margin-bottom: 20px;">×‘×—×¨ ×—×œ×•×§×” ×—×“×©×”</h3>
    <div id="changeGroupContent"></div>
    <button class="action-button secondary" id="closeChangeGroupModal" style="margin-top: 20px;">×‘×™×˜×•×œ</button>
   </div>
  </div>

  <!-- ×—×œ×•×Ÿ ×¤×¨×˜×™ ××©×—×§ -->
  <div id="gameDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center;">
   <div style="background: white; padding: 30px; border-radius: 15px; max-width: 800px; width: 90%; max-height: 80%; overflow-y: auto;">
    <h3 style="color: #667eea; margin-bottom: 20px;" id="gameDetailsTitle">×¤×¨×˜×™ ××©×—×§</h3>
    <div id="gameDetailsContent"></div>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="action-button" id="continueFromDetailsBtn">×”××©×š ××©×—×§</button>
      <button class="action-button secondary" id="closeGameDetailsModal">×¡×’×•×¨</button>
    </div>
   </div>
  </div>

  <!-- ×—×œ×•×Ÿ ×”×¦×’×ª ×¤×¨×˜×™ ××©×™××” -->
  <div id="taskDetailsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; align-items: center; justify-content: center;">
   <div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto;">
    <h3 style="color: #667eea; margin-bottom: 20px;" id="taskDetailsModalTitle">×¤×¨×˜×™ ××©×™××”</h3>
    <div id="taskDetailsModalContent"></div>
    <button class="action-button secondary" id="closeTaskDetailsModal" style="margin-top: 20px;">×¡×’×•×¨</button>
   </div>
  </div>

  <!-- ×—×œ×•×Ÿ ×¢×¨×™×›×ª ×ª×•×¦××•×ª ××©×™××” -->
  <div id="editTaskResultsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2001; align-items: center; justify-content: center;">
   <div style="background: white; padding: 30px; border-radius: 15px; max-width: 700px; width: 90%; max-height: 80%; overflow-y: auto;">
    <h3 style="color: #667eea; margin-bottom: 20px;" id="editTaskResultsTitle">×¢×¨×™×›×ª ×ª×•×¦××•×ª ××©×™××”</h3>
    <div id="editTaskResultsContent"></div>
    <div style="margin-top: 20px; display: flex; gap: 10px;">
      <button class="action-button" id="saveTaskResultsBtn">×©××•×¨ ×©×™× ×•×™×™×</button>
      <button class="action-button secondary" id="closeEditTaskResultsModal">×‘×™×˜×•×œ</button>
    </div>
   </div>
  </div>

  <!-- ××¡×š ×”×’×“×¨×•×ª -->
  <div class="secondary-screen" id="settingsScreen">
    <button class="back-button" id="backFromSettings">â† ×—×–×•×¨</button>
    <h2 class="section-title">×”×’×“×¨×•×ª</h2>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×”×•×¡×¤×ª ××©×™××•×ª</h3>
      <div class="form-group">
        <label for="taskName" class="form-label">×©× ×”××©×™××”:</label>
        <input type="text" id="taskName" class="form-input" placeholder="×œ×“×•×’××”: ××™×¡×•×£ ×¦×™×•×“">
      </div>
      <div class="form-group">
        <label for="taskDesc" class="form-label">×ª×™××•×¨ ×”××©×™××” (×”×•×¨××•×ª):</label>
        <textarea id="taskDesc" class="form-textarea" placeholder="×¤×¨×˜ ××ª ×”×”×•×¨××•×ª ×œ××©×™××”"></textarea>
      </div>
      <button class="action-button" id="addTaskBtn">×”×•×¡×£ ××©×™××”</button>
    </div>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×¨×©×™××ª ××©×™××•×ª</h3>
      <div id="tasksList"></div>
    </div>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×—×œ×•×§×ª ×§×‘×•×¦×•×ª</h3>
      <div class="form-group">
        <label for="groupName" class="form-label">×©× ×”×—×œ×•×§×”:</label>
        <input type="text" id="groupName" class="form-input" placeholder="×œ×“×•×’××”: ×—×œ×•×§×” ×'">
      </div>
      <button class="action-button" id="createGroupBtn">×¦×•×¨ ×—×œ×•×§×”</button>
    </div>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×¨×©×™××ª ×—×œ×•×§×•×ª</h3>
      <div id="groupsList"></div>
    </div>
  </div>

  <!-- ××¡×š ×¢×¨×™×›×ª ×—×œ×•×§×” -->
  <div class="secondary-screen" id="editGroupScreen">
    <button class="back-button" id="backFromEditGroup">â† ×—×–×•×¨</button>
    <h2 class="section-title" id="editGroupTitle">×¢×¨×™×›×ª ×—×œ×•×§×”</h2>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×”×•×¡×¤×ª ×§×‘×•×¦×”</h3>
      <div class="form-group">
        <label for="teamName" class="form-label">×©× ×”×§×‘×•×¦×”:</label>
        <input type="text" id="teamName" class="form-input" placeholder="×œ×“×•×’××”: ×§×‘×•×¦×” ××“×•××”">
      </div>
      <div class="form-group">
        <label for="teamMembers" class="form-label">×©××•×ª ×”×™×œ×“×™× (××•×¤×¨×“×™× ×‘×¤×¡×™×§):</label>
        <textarea id="teamMembers" class="form-textarea" placeholder="×“×•×“, ×©×¨×”, ×™×•×¡×™, ×¨×—×œ"></textarea>
      </div>
      <button class="action-button" id="addTeamBtn">×”×•×¡×£ ×§×‘×•×¦×”</button>
    </div>
    <div class="content-card">
      <h3 style="color: #667eea; margin-bottom: 20px;">×§×‘×•×¦×•×ª</h3>
      <div id="teamsList"></div>
    </div>
  </div>

  <!-- ×”×•×“×¢×ª Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, where, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDlyDbpwcBcWvFnvYHb84dMEpaQFTjv-HY",
      authDomain: "tester-69fa9.firebaseapp.com",
      databaseURL: "https://tester-69fa9-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "tester-69fa9",
      storageBucket: "tester-69fa9.firebasestorage.app",
      messagingSenderId: "378563229004",
      appId: "1:378563229004:web:5136b724eb84fd00e44be9",
      measurementId: "G-BFJ1QQM3MS"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Global variables
    let currentEditingGroupId = null;
    let allTasks = [];
    let allGroups = [];
    let allTeams = [];
    let allGames = [];
    let allGameTasks = [];
    let currentActiveGame = null;
    let selectedGroupForNewGame = null;
    let currentTaskExecution = null;
    let timerInterval = null;
    let timerStartTime = null;
    let finishedTeams = [];

    // Firebase helper functions
    async function loadAllData() {
      try {
        const tasksSnapshot = await getDocs(collection(db, 'tasks'));
        allTasks = tasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const groupsSnapshot = await getDocs(collection(db, 'groups'));
        allGroups = groupsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const teamsSnapshot = await getDocs(collection(db, 'teams'));
        allTeams = teamsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const gamesSnapshot = await getDocs(collection(db, 'games'));
        allGames = gamesSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        const gameTasksSnapshot = await getDocs(collection(db, 'gameTasks'));
        allGameTasks = gameTasksSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        updateUI();
      } catch (error) {
        console.error('Error loading data:', error);
        showToast('×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
      }
    }

    function setupRealtimeListeners() {
      onSnapshot(collection(db, 'tasks'), (snapshot) => {
        allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateUI();
      });

      onSnapshot(collection(db, 'groups'), (snapshot) => {
        allGroups = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateUI();
      });

      onSnapshot(collection(db, 'teams'), (snapshot) => {
        allTeams = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateUI();
      });

      onSnapshot(collection(db, 'games'), (snapshot) => {
        allGames = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateUI();
      });

      onSnapshot(collection(db, 'gameTasks'), (snapshot) => {
        allGameTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateUI();
      });
    }

    function updateUI() {
      renderTasksList();
      renderGroupsList();
      if (currentEditingGroupId) {
        renderTeamsList();
      }
      
      const selectGroupDiv = document.getElementById('selectGroupForGame');
      if (selectGroupDiv && selectGroupDiv.innerHTML !== '') {
        renderGroupSelectionForGame();
      }
      
      const previousGamesDiv = document.getElementById('previousGamesList');
      if (previousGamesDiv && previousGamesDiv.innerHTML !== '') {
        renderPreviousGames();
      }
      
      if (currentActiveGame) {
        const game = allGames.find(g => g.id === currentActiveGame);
        if (game) {
          renderDashboardContent();
        }
      }
    }

    function setupEventListeners() {
      document.getElementById('loginButton').addEventListener('click', handleLogin);
      document.getElementById('passwordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') handleLogin();
      });

      document.getElementById('settingsBtn').addEventListener('click', () => showScreen('settings'));
      document.getElementById('newGameBtn').addEventListener('click', handleNewGame);
      document.getElementById('previousGamesBtn').addEventListener('click', handlePreviousGames);
      
      document.getElementById('backFromSettings').addEventListener('click', () => showScreen('main'));
      document.getElementById('backFromEditGroup').addEventListener('click', () => {
        currentEditingGroupId = null;
        showScreen('settings');
      });

      document.getElementById('addTaskBtn').addEventListener('click', handleAddTask);
      document.getElementById('createGroupBtn').addEventListener('click', handleCreateGroup);
      document.getElementById('addTeamBtn').addEventListener('click', handleAddTeam);

      document.getElementById('backFromNewGame').addEventListener('click', () => {
        selectedGroupForNewGame = null;
        showScreen('main');
      });
      document.getElementById('startGameBtn').addEventListener('click', handleStartGame);

      document.getElementById('backFromDashboard').addEventListener('click', () => showScreen('main'));
      document.getElementById('selectTaskBtn').addEventListener('click', () => showScreen('selectTask'));
      document.getElementById('showResultsBtn').addEventListener('click', showResults);
      document.getElementById('showGroupDashBtn').addEventListener('click', showGroupModal);
      document.getElementById('showPrevTasksBtn').addEventListener('click', showPreviousTasks);

      document.getElementById('backFromSelectTask').addEventListener('click', () => showScreen('dashboard'));

      document.getElementById('backFromTaskExecution').addEventListener('click', () => {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        showScreen('dashboard');
      });

      document.getElementById('backFromResults').addEventListener('click', () => showScreen('dashboard'));
      document.getElementById('backFromPrevTasks').addEventListener('click', () => showScreen('dashboard'));
      document.getElementById('backFromPreviousGames').addEventListener('click', () => showScreen('main'));

      document.getElementById('closeGroupModal').addEventListener('click', () => {
        document.getElementById('groupModal').style.display = 'none';
      });
      document.getElementById('changeGroupBtn').addEventListener('click', () => {
        document.getElementById('changeGroupModal').style.display = 'flex';
        renderChangeGroupModal();
      });
      document.getElementById('closeChangeGroupModal').addEventListener('click', () => {
        document.getElementById('changeGroupModal').style.display = 'none';
      });

      document.getElementById('closeGameDetailsModal').addEventListener('click', () => {
        document.getElementById('gameDetailsModal').style.display = 'none';
      });
      document.getElementById('continueFromDetailsBtn').addEventListener('click', () => {
        const gameId = document.getElementById('continueFromDetailsBtn').dataset.gameId;
        const gameName = document.getElementById('continueFromDetailsBtn').dataset.gameName;
        document.getElementById('gameDetailsModal').style.display = 'none';
        continueGame(gameId, gameName);
      });

      document.getElementById('closeTaskDetailsModal').addEventListener('click', () => {
        document.getElementById('taskDetailsModal').style.display = 'none';
      });

      document.getElementById('closeEditTaskResultsModal').addEventListener('click', () => {
        document.getElementById('editTaskResultsModal').style.display = 'none';
      });

      document.getElementById('saveTaskResultsBtn').addEventListener('click', saveTaskResults);
    }

    function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const errorMsg = document.getElementById('errorMessage');
      
      if (password === '1234') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainScreen').style.display = 'block';
        document.querySelector('.background-animation').style.display = 'none';
        errorMsg.style.display = 'none';
      } else {
        errorMsg.style.display = 'block';
      }
    }

    function showScreen(screen) {
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('settingsScreen').style.display = 'none';
      document.getElementById('editGroupScreen').style.display = 'none';
      document.getElementById('newGameScreen').style.display = 'none';
      document.getElementById('dashboardScreen').style.display = 'none';
      document.getElementById('selectTaskScreen').style.display = 'none';
      document.getElementById('taskExecutionScreen').style.display = 'none';
      document.getElementById('resultsScreen').style.display = 'none';
      document.getElementById('prevTasksScreen').style.display = 'none';
      document.getElementById('previousGamesScreen').style.display = 'none';

      if (screen === 'main') {
        document.getElementById('mainScreen').style.display = 'block';
      } else if (screen === 'settings') {
        document.getElementById('settingsScreen').style.display = 'block';
      } else if (screen === 'editGroup') {
        document.getElementById('editGroupScreen').style.display = 'block';
      } else if (screen === 'newGame') {
        document.getElementById('newGameScreen').style.display = 'block';
        renderGroupSelectionForGame();
      } else if (screen === 'dashboard') {
        document.getElementById('dashboardScreen').style.display = 'block';
        renderDashboardContent();
      } else if (screen === 'selectTask') {
        document.getElementById('selectTaskScreen').style.display = 'block';
        renderTasksForSelection();
      } else if (screen === 'taskExecution') {
        document.getElementById('taskExecutionScreen').style.display = 'block';
      } else if (screen === 'results') {
        document.getElementById('resultsScreen').style.display = 'block';
      } else if (screen === 'prevTasks') {
        document.getElementById('prevTasksScreen').style.display = 'block';
      } else if (screen === 'previousGames') {
        document.getElementById('previousGamesScreen').style.display = 'block';
        renderPreviousGames();
      }
    }

    function handleNewGame() {
      if (allGroups.length === 0) {
        showToast('××™×Ÿ ×—×œ×•×§×•×ª ×§×‘×•×¦×•×ª. ×¦×•×¨ ×—×œ×•×§×” ×‘×”×’×“×¨×•×ª ×ª×—×™×œ×”');
        return;
      }
      selectedGroupForNewGame = null;
      showScreen('newGame');
    }

    function handlePreviousGames() {
      showScreen('previousGames');
    }

    function renderGroupSelectionForGame() {
      const container = document.getElementById('selectGroupForGame');
      const startBtn = document.getElementById('startGameBtn');
      
      if (allGroups.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ×—×œ×•×§×•×ª ×§×‘×•×¦×•×ª. ×¦×•×¨ ×—×œ×•×§×” ×‘×”×’×“×¨×•×ª</div>';
        startBtn.disabled = true;
        return;
      }

      container.innerHTML = allGroups.map(group => {
        const teams = allTeams.filter(t => t.groupId === group.id);
        const isSelected = selectedGroupForNewGame === group.id;
        return `
          <div class="list-item" style="cursor: pointer; border: 2px solid ${isSelected ? '#667eea' : 'transparent'};" onclick="window.selectGroupForGame('${group.id}')">
            <div class="list-item-content">
              <div class="list-item-title">${group.name}</div>
              <div class="list-item-desc">${teams.length} ×§×‘×•×¦×•×ª</div>
            </div>
            ${isSelected ? '<span style="color: #667eea; font-weight: bold;">âœ“ × ×‘×—×¨</span>' : ''}
          </div>
        `;
      }).join('');

      startBtn.disabled = !selectedGroupForNewGame;
    }

    window.selectGroupForGame = function(groupId) {
      selectedGroupForNewGame = groupId;
      renderGroupSelectionForGame();
    }

    async function handleStartGame() {
      if (!selectedGroupForNewGame) {
        showToast('× × ×œ×‘×—×•×¨ ×—×œ×•×§×ª ×§×‘×•×¦×•×ª');
        return;
      }

      const teams = allTeams.filter(t => t.groupId === selectedGroupForNewGame);
      if (teams.length === 0) {
        showToast('×”×—×œ×•×§×” ×”× ×‘×—×¨×ª ××™× ×” ××›×™×œ×” ×§×‘×•×¦×•×ª');
        return;
      }

      const today = new Date();
      const dateStr = `${today.getDate()}/${today.getMonth() + 1}/${today.getFullYear()}`;
      
      const todayGames = allGames.filter(g => g.gameDate === dateStr);
      const dailyCounter = todayGames.length + 1;
      
      const gameName = `××™×¨×•×¥ ×”××©×™××•×ª ${dateStr} (${dailyCounter})`;
      
      try {
        const docRef = await addDoc(collection(db, 'games'), {
          gameName: gameName,
          gameDate: dateStr,
          dailyCounter: dailyCounter,
          activeGroupId: selectedGroupForNewGame,
          status: 'active',
          createdAt: new Date().toISOString()
        });

        currentActiveGame = docRef.id;
        document.getElementById('dashboardTitle').textContent = `×œ×•×— ××—×•×•× ×™× - ${gameName}`;
        showScreen('dashboard');
        showToast('×”××©×—×§ ×”×ª×—×™×œ!');
      } catch (error) {
        console.error('Error creating game:', error);
        showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×”××©×—×§');
      }
    }

    function renderDashboardContent() {
      const container = document.getElementById('dashboardContent');
      
      if (!currentActiveGame) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">×œ×—×¥ ×¢×œ "×‘×—×¨ ××©×™××”" ×œ×”×ª×—×œ×ª ××©×™××” ×—×“×©×”</div>';
        return;
      }

      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame);
      const uniqueTasks = [...new Set(gameTasks.map(gt => gt.taskId))];
      
      if (uniqueTasks.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">×œ×—×¥ ×¢×œ "×‘×—×¨ ××©×™××”" ×œ×”×ª×—×œ×ª ××©×™××” ×—×“×©×”</div>';
      } else {
        container.innerHTML = `<div style="text-align: center; padding: 20px; color: #666;">×¡×š ×”×›×œ ${uniqueTasks.length} ××©×™××•×ª ×”×•×©×œ××•</div>`;
      }
    }

    function renderTasksForSelection() {
      const container = document.getElementById('tasksForSelection');
      
      if (allTasks.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ××©×™××•×ª. ×”×•×¡×£ ××©×™××•×ª ×‘×”×’×“×¨×•×ª</div>';
        return;
      }

      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame);
      const completedTaskIds = [...new Set(gameTasks.map(gt => gt.taskId))];
      
      const availableTasks = allTasks.filter(t => !completedTaskIds.includes(t.id));
      const completedTasks = allTasks.filter(t => completedTaskIds.includes(t.id));

      let html = '';
      
      if (availableTasks.length > 0) {
        html += '<h3 style="color: #667eea; margin-bottom: 15px;">××©×™××•×ª ×–××™× ×•×ª</h3>';
        html += availableTasks.map(task => `
          <div class="list-item" style="cursor: pointer;" onclick="window.startTaskExecution('${task.id}')">
            <div class="list-item-content">
              <div class="list-item-title">${task.name}</div>
              <div class="list-item-desc">${task.description}</div>
            </div>
            <button class="action-button">×”×ª×—×œ â†’</button>
          </div>
        `).join('');
      }
      
      if (completedTasks.length > 0) {
        html += '<h3 style="color: #999; margin: 30px 0 15px 0;">××©×™××•×ª ×©×‘×•×¦×¢×•</h3>';
        html += completedTasks.map(task => `
          <div class="list-item" style="cursor: pointer; opacity: 0.6; background: #e8e8e8;" onclick="window.startTaskExecution('${task.id}')">
            <div class="list-item-content">
              <div class="list-item-title" style="color: #666;">${task.name}</div>
              <div class="list-item-desc" style="color: #999;">${task.description}</div>
            </div>
            <button class="action-button secondary">×”×ª×—×œ ×©×•×‘ â†’</button>
          </div>
        `).join('');
      }

      container.innerHTML = html;
    }

    window.startTaskExecution = function(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      currentTaskExecution = {
        taskId: taskId,
        taskName: task.name,
        taskDesc: task.description
      };

      document.getElementById('taskExecTitle').textContent = task.name;
      
      const detailsHtml = `
        <h3 style="color: #667eea; margin-bottom: 15px;">${task.name}</h3>
        <p style="color: #666; line-height: 1.6;">${task.description}</p>
      `;
      
      document.getElementById('taskDetails').innerHTML = detailsHtml;
      
      const timerHtml = `
        <div style="text-align: center;">
          <button class="action-button" id="startTimerBtn" style="font-size: 20px; padding: 20px 40px;">×”×ª×—×œ ×˜×™×™××¨</button>
        </div>
      `;
      
      document.getElementById('timerSection').innerHTML = timerHtml;
      document.getElementById('startTimerBtn').addEventListener('click', startTimer);
      
      showScreen('taskExecution');
    }

    function startTimer() {
      const game = allGames.find(g => g.id === currentActiveGame);
      if (!game) return;

      const teams = allTeams.filter(t => t.groupId === game.activeGroupId);
      if (teams.length === 0) return;

      timerStartTime = Date.now();
      finishedTeams = [];
      
      let timerHtml = `
        <div style="text-align: center; margin-bottom: 30px;">
          <div style="font-size: 48px; font-weight: bold; color: #667eea; margin-bottom: 20px;" id="timerDisplay">00:00</div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      `;
      
      teams.forEach((team, index) => {
        timerHtml += `
          <div id="teamTimer${index}">
            <button class="action-button" style="width: 100%; padding: 20px;" onclick="window.stopTeamTimer('${team.id}', ${index}, '${team.name}')">
              ×¢×¦×•×¨ ×˜×™×™××¨<br>${team.name}
            </button>
          </div>
        `;
      });
      
      timerHtml += '</div>';
      
      document.getElementById('timerSection').innerHTML = timerHtml;
      
      timerInterval = setInterval(updateTimerDisplay, 100);
    }

    function updateTimerDisplay() {
      if (!timerStartTime) return;
      
      const elapsed = Date.now() - timerStartTime;
      const seconds = Math.floor(elapsed / 1000);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      
      const display = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
      const displayElement = document.getElementById('timerDisplay');
      if (displayElement) {
        displayElement.textContent = display;
      }
    }

    window.stopTeamTimer = function(teamId, teamIndex, teamName) {
      if (finishedTeams.find(ft => ft.teamId === teamId)) {
        showToast('×”×§×‘×•×¦×” ×›×‘×¨ ×¡×™×™××”');
        return;
      }

      const completedTime = Date.now() - timerStartTime;
      const rank = finishedTeams.length + 1;
      
      finishedTeams.push({
        teamId: teamId,
        teamName: teamName,
        rank: rank,
        completedTime: completedTime
      });

      const teamContainer = document.getElementById(`teamTimer${teamIndex}`);
      if (teamContainer) {
        teamContainer.innerHTML = `
          <div style="background: #f0f0f0; padding: 20px; border-radius: 8px; text-align: center;">
            <div style="font-weight: bold; color: #667eea; margin-bottom: 10px;">${teamName}</div>
            <div style="color: #666;">××§×•× ${rank}</div>
            <div style="margin-top: 10px;">
              <button class="action-button" style="width: 100%; margin-bottom: 5px;" onclick="window.confirmTeamComplete('${teamId}', true)">×›×œ ×”×§×‘×•×¦×” ×”×’×™×¢×”</button>
              <button class="action-button secondary" style="width: 100%;" onclick="window.confirmTeamComplete('${teamId}', false)">×—×¡×¨×™× ×™×œ×“×™×</button>
            </div>
          </div>
        `;
      }

      const game = allGames.find(g => g.id === currentActiveGame);
      const teams = allTeams.filter(t => t.groupId === game.activeGroupId);
      
      if (finishedTeams.length === teams.length) {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }
    }

    window.confirmTeamComplete = async function(teamId, allPresent) {
      const finished = finishedTeams.find(ft => ft.teamId === teamId);
      if (!finished) return;

      let points = 0;
      if (allPresent) {
        if (finished.rank === 1) points = 3;
        else if (finished.rank === 2) points = 2;
        else if (finished.rank === 3) points = 1;
        else points = 0;
      }

      try {
        await addDoc(collection(db, 'gameTasks'), {
          gameId: currentActiveGame,
          taskId: currentTaskExecution.taskId,
          teamId: teamId,
          rank: finished.rank,
          completedTime: finished.completedTime,
          allMembersPresent: allPresent,
          points: points,
          createdAt: new Date().toISOString()
        });

        const allConfirmed = finishedTeams.every(ft => {
          return allGameTasks.some(gt => gt.teamId === ft.teamId && gt.taskId === currentTaskExecution.taskId);
        });

        if (allConfirmed) {
          showToast('×”××©×™××” ×”×•×©×œ××”!');
          setTimeout(() => {
            showScreen('dashboard');
          }, 1500);
        } else {
          showToast('×ª×•×¦××ª ×”×§×‘×•×¦×” × ×©××¨×”');
        }
      } catch (error) {
        console.error('Error saving task result:', error);
        showToast('×©×’×™××” ×‘×©××™×¨×ª ×”×ª×•×¦××”');
      }
    }

    function showResults() {
      if (!currentActiveGame) {
        showToast('××™×Ÿ ××©×—×§ ×¤×¢×™×œ');
        return;
      }

      const game = allGames.find(g => g.id === currentActiveGame);
      if (!game) return;

      const teams = allTeams.filter(t => t.groupId === game.activeGroupId);
      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame);

      const teamScores = teams.map(team => {
        const teamTasks = gameTasks.filter(gt => gt.teamId === team.id);
        const totalPoints = teamTasks.reduce((sum, gt) => sum + gt.points, 0);
        return {
          teamName: team.name,
          totalPoints: totalPoints
        };
      });

      teamScores.sort((a, b) => b.totalPoints - a.totalPoints);

      let html = '<h3 style="color: #667eea; margin-bottom: 20px;">×œ×•×— × ×™×§×•×“</h3>';
      
      teamScores.forEach((team, index) => {
        const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${medal} ××§×•× ${index + 1}: ${team.teamName}</div>
            </div>
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">${team.totalPoints} × ×§'</div>
          </div>
        `;
      });

      document.getElementById('resultsContent').innerHTML = html;
      showScreen('results');
    }

    function showPreviousTasks() {
      if (!currentActiveGame) {
        showToast('××™×Ÿ ××©×—×§ ×¤×¢×™×œ');
        return;
      }

      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame);
      
      if (gameTasks.length === 0) {
        document.getElementById('prevTasksContent').innerHTML = '<div class="empty-state">××™×Ÿ ××©×™××•×ª ×§×•×“××•×ª ×‘××©×—×§ ×–×”</div>';
        showScreen('prevTasks');
        return;
      }

      const taskIds = [...new Set(gameTasks.map(gt => gt.taskId))];
      
      let html = '';
      taskIds.forEach(taskId => {
        const task = allTasks.find(t => t.id === taskId);
        if (!task) return;
        
        html += `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${task.name}</div>
            </div>
            <div>
              <button class="action-button" style="margin-left: 10px;" onclick="window.viewTaskDetails('${taskId}')">×”×¦×’</button>
              <button class="action-button secondary" onclick="window.editTaskResults('${taskId}')">×¢×¨×•×š</button>
            </div>
          </div>
        `;
      });

      document.getElementById('prevTasksContent').innerHTML = html;
      showScreen('prevTasks');
    }

    window.viewTaskDetails = function(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame && gt.taskId === taskId);
      
      document.getElementById('taskDetailsModalTitle').textContent = task.name;
      
      let html = `
        <div style="margin-bottom: 20px;">
          <h4 style="color: #667eea; margin-bottom: 10px;">×ª×™××•×¨ ×”××©×™××”</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; line-height: 1.6;">
            ${task.description}
          </div>
        </div>
        <div>
          <h4 style="color: #667eea; margin-bottom: 10px;">×ª×•×¦××•×ª</h4>
      `;
      
      const sortedResults = [...gameTasks].sort((a, b) => a.rank - b.rank);
      
      sortedResults.forEach(result => {
        const team = allTeams.find(t => t.id === result.teamId);
        const teamName = team ? team.name : '×œ× ×™×“×•×¢';
        
        html += `
          <div class="list-item" style="margin-bottom: 10px;">
            <div class="list-item-content">
              <div class="list-item-title">××§×•× ${result.rank}: ${teamName}</div>
              <div class="list-item-desc">${result.allMembersPresent ? '×›×œ ×”×§×‘×•×¦×” ×”×’×™×¢×”' : '×—×¡×¨×• ×™×œ×“×™×'}</div>
            </div>
            <div style="font-size: 20px; font-weight: bold; color: #667eea;">${result.points} × ×§'</div>
          </div>
        `;
      });
      
      html += '</div>';

      document.getElementById('taskDetailsModalContent').innerHTML = html;
      document.getElementById('taskDetailsModal').style.display = 'flex';
    }

    let currentEditingTaskResults = null;

    window.editTaskResults = function(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      const gameTasks = allGameTasks.filter(gt => gt.gameId === currentActiveGame && gt.taskId === taskId);
      currentEditingTaskResults = gameTasks;
      
      document.getElementById('editTaskResultsTitle').textContent = `×¢×¨×™×›×ª ×ª×•×¦××•×ª: ${task.name}`;
      
      let html = '';
      
      const sortedResults = [...gameTasks].sort((a, b) => a.rank - b.rank);
      
      sortedResults.forEach((result, index) => {
        const team = allTeams.find(t => t.id === result.teamId);
        const teamName = team ? team.name : '×œ× ×™×“×•×¢';
        
        html += `
          <div class="list-item" style="margin-bottom: 15px;">
            <div style="flex: 1;">
              <div style="font-weight: bold; color: #333; margin-bottom: 10px;">${teamName}</div>
              <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 5px;">
                  <span style="font-size: 14px;">××§×•×:</span>
                  <input type="number" min="1" value="${result.rank}" 
                    style="width: 60px; padding: 5px; border: 2px solid #e0e0e0; border-radius: 5px;"
                    data-result-id="${result.id}" data-field="rank">
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                  <input type="checkbox" ${result.allMembersPresent ? 'checked' : ''}
                    data-result-id="${result.id}" data-field="allMembersPresent">
                  <span style="font-size: 14px;">×›×œ ×”×§×‘×•×¦×” ×”×’×™×¢×”</span>
                </label>
                <label style="display: flex; align-items: center; gap: 5px;">
                  <span style="font-size: 14px;">× ×§×•×“×•×ª:</span>
                  <input type="number" min="0" value="${result.points}" 
                    style="width: 60px; padding: 5px; border: 2px solid #e0e0e0; border-radius: 5px;"
                    data-result-id="${result.id}" data-field="points">
                </label>
              </div>
            </div>
          </div>
        `;
      });

      document.getElementById('editTaskResultsContent').innerHTML = html;
      document.getElementById('editTaskResultsModal').style.display = 'flex';
    }

    async function saveTaskResults() {
      const inputs = document.querySelectorAll('[data-result-id]');
      const updates = new Map();

      inputs.forEach(input => {
        const resultId = input.dataset.resultId;
        const field = input.dataset.field;
        
        if (!updates.has(resultId)) {
          const result = currentEditingTaskResults.find(r => r.id === resultId);
          if (result) {
            updates.set(resultId, { ...result });
          }
        }

        const resultUpdate = updates.get(resultId);
        if (resultUpdate) {
          if (field === 'rank') {
            resultUpdate.rank = parseInt(input.value) || 1;
          } else if (field === 'allMembersPresent') {
            resultUpdate.allMembersPresent = input.checked;
          } else if (field === 'points') {
            resultUpdate.points = parseInt(input.value) || 0;
          }
        }
      });

      let successCount = 0;
      for (const [resultId, resultUpdate] of updates) {
        try {
          const docRef = doc(db, 'gameTasks', resultId);
          await updateDoc(docRef, {
            rank: resultUpdate.rank,
            allMembersPresent: resultUpdate.allMembersPresent,
            points: resultUpdate.points
          });
          successCount++;
        } catch (error) {
          console.error('Error updating result:', error);
        }
      }

      if (successCount === updates.size) {
        document.getElementById('editTaskResultsModal').style.display = 'none';
        showToast('×”×ª×•×¦××•×ª ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”');
        currentEditingTaskResults = null;
      } else {
        showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×—×œ×§ ××”×ª×•×¦××•×ª');
      }
    }

    function showGroupModal() {
      if (!currentActiveGame) {
        showToast('××™×Ÿ ××©×—×§ ×¤×¢×™×œ');
        return;
      }

      const game = allGames.find(g => g.id === currentActiveGame);
      if (!game) return;

      const group = allGroups.find(g => g.id === game.activeGroupId);
      const teams = allTeams.filter(t => t.groupId === game.activeGroupId);

      let html = `<h4 style="margin-bottom: 15px;">${group ? group.name : '×œ× ×™×“×•×¢'}</h4>`;
      html += '<div class="teams-container">';
      
      teams.forEach(team => {
        html += `
          <div class="team-card">
            <div class="team-name">${team.name}</div>
            <div class="team-members">${team.members}</div>
          </div>
        `;
      });
      
      html += '</div>';

      document.getElementById('groupModalContent').innerHTML = html;
      document.getElementById('groupModal').style.display = 'flex';
    }

    function renderChangeGroupModal() {
      const container = document.getElementById('changeGroupContent');
      
      container.innerHTML = allGroups.map(group => {
        const teams = allTeams.filter(t => t.groupId === group.id);
        return `
          <div class="list-item" style="cursor: pointer;" onclick="window.changeActiveGroup('${group.id}')">
            <div class="list-item-content">
              <div class="list-item-title">${group.name}</div>
              <div class="list-item-desc">${teams.length} ×§×‘×•×¦×•×ª</div>
            </div>
            <button class="action-button">×‘×—×¨</button>
          </div>
        `;
      }).join('');
    }

    window.changeActiveGroup = async function(newGroupId) {
      if (!currentActiveGame) return;

      const game = allGames.find(g => g.id === currentActiveGame);
      if (!game) return;

      try {
        const docRef = doc(db, 'games', currentActiveGame);
        await updateDoc(docRef, {
          activeGroupId: newGroupId
        });

        document.getElementById('changeGroupModal').style.display = 'none';
        document.getElementById('groupModal').style.display = 'none';
        showToast('×”×—×œ×•×§×” ×©×•× ×ª×” ×‘×”×¦×œ×—×”');
        renderDashboardContent();
      } catch (error) {
        console.error('Error updating group:', error);
        showToast('×©×’×™××” ×‘×©×™× ×•×™ ×”×—×œ×•×§×”');
      }
    }

    function renderPreviousGames() {
      const container = document.getElementById('previousGamesList');
      
      const previousGames = allGames.filter(g => g.status === 'active' || g.status === 'completed');
      
      if (previousGames.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ××©×—×§×™× ×§×•×“××™×</div>';
        return;
      }

      previousGames.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

      container.innerHTML = previousGames.map(game => {
        return `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${game.gameName}</div>
            </div>
            <div>
              <button class="action-button" style="margin-left: 10px;" onclick="window.viewGameDetails('${game.id}')">×¦×¤×”</button>
              <button class="action-button secondary" onclick="window.continueGame('${game.id}', '${game.gameName}')">×”××©×š</button>
            </div>
          </div>
        `;
      }).join('');
    }

    window.viewGameDetails = function(gameId) {
      const game = allGames.find(g => g.id === gameId);
      if (!game) return;

      document.getElementById('gameDetailsTitle').textContent = game.gameName;
      
      const group = allGroups.find(g => g.id === game.activeGroupId);
      const teams = allTeams.filter(t => t.groupId === game.activeGroupId);
      const gameTasks = allGameTasks.filter(gt => gt.gameId === game.id);
      const uniqueTaskIds = [...new Set(gameTasks.map(gt => gt.taskId))];

      let html = `
        <div style="margin-bottom: 25px;">
          <h4 style="color: #667eea; margin-bottom: 10px;">×¤×¨×˜×™ ×”××©×—×§</h4>
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
            <div style="margin-bottom: 8px;"><strong>×ª××¨×™×š:</strong> ${game.gameDate}</div>
            <div style="margin-bottom: 8px;"><strong>×—×œ×•×§×ª ×§×‘×•×¦×•×ª:</strong> ${group ? group.name : '×œ× ×™×“×•×¢'}</div>
            <div><strong>××¡×¤×¨ ××©×™××•×ª:</strong> ${uniqueTaskIds.length}</div>
          </div>
        </div>

        <div style="margin-bottom: 25px;">
          <h4 style="color: #667eea; margin-bottom: 10px;">×§×‘×•×¦×•×ª</h4>
          <div class="teams-container">
      `;
      
      teams.forEach(team => {
        html += `
          <div class="team-card">
            <div class="team-name">${team.name}</div>
            <div class="team-members">${team.members}</div>
          </div>
        `;
      });
      
      html += '</div></div>';

      if (uniqueTaskIds.length > 0) {
        html += '<div><h4 style="color: #667eea; margin-bottom: 10px;">×œ×•×— × ×™×§×•×“</h4>';
        
        const teamScores = teams.map(team => {
          const teamTasks = gameTasks.filter(gt => gt.teamId === team.id);
          const totalPoints = teamTasks.reduce((sum, gt) => sum + gt.points, 0);
          return {
            teamName: team.name,
            totalPoints: totalPoints
          };
        });

        teamScores.sort((a, b) => b.totalPoints - a.totalPoints);

        teamScores.forEach((team, index) => {
          const medal = index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : '';
          html += `
            <div class="list-item" style="margin-bottom: 10px;">
              <div class="list-item-content">
                <div class="list-item-title">${medal} ××§×•× ${index + 1}: ${team.teamName}</div>
              </div>
              <div style="font-size: 24px; font-weight: bold; color: #667eea;">${team.totalPoints} × ×§'</div>
            </div>
          `;
        });
        
        html += '</div>';
      }

      document.getElementById('gameDetailsContent').innerHTML = html;
      document.getElementById('continueFromDetailsBtn').dataset.gameId = gameId;
      document.getElementById('continueFromDetailsBtn').dataset.gameName = game.gameName;
      document.getElementById('gameDetailsModal').style.display = 'flex';
    }

    window.continueGame = function(gameId, gameName) {
      currentActiveGame = gameId;
      document.getElementById('dashboardTitle').textContent = `×œ×•×— ××—×•×•× ×™× - ${gameName}`;
      showScreen('dashboard');
      showToast('×××©×™×š ××©×—×§');
    }

    async function handleAddTask() {
      const name = document.getElementById('taskName').value.trim();
      const description = document.getElementById('taskDesc').value.trim();

      if (!name || !description) {
        showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
        return;
      }

      try {
        await addDoc(collection(db, 'tasks'), {
          name: name,
          description: description,
          createdAt: new Date().toISOString()
        });

        document.getElementById('taskName').value = '';
        document.getElementById('taskDesc').value = '';
        showToast('×”××©×™××” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error adding task:', error);
        showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”××©×™××”');
      }
    }

    async function handleCreateGroup() {
      const groupName = document.getElementById('groupName').value.trim();

      if (!groupName) {
        showToast('× × ×œ×”×–×™×Ÿ ×©× ×œ×—×œ×•×§×”');
        return;
      }

      try {
        await addDoc(collection(db, 'groups'), {
          name: groupName,
          createdAt: new Date().toISOString()
        });

        document.getElementById('groupName').value = '';
        showToast('×”×—×œ×•×§×” × ×•×¦×¨×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error creating group:', error);
        showToast('×©×’×™××” ×‘×™×¦×™×¨×ª ×”×—×œ×•×§×”');
      }
    }

    async function handleAddTeam() {
      const teamName = document.getElementById('teamName').value.trim();
      const members = document.getElementById('teamMembers').value.trim();

      if (!teamName || !members) {
        showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
        return;
      }

      const currentTeams = allTeams.filter(t => t.groupId === currentEditingGroupId);
      if (currentTeams.length >= 4) {
        showToast('× ×™×ª×Ÿ ×œ×”×•×¡×™×£ ×¢×“ 4 ×§×‘×•×¦×•×ª ×‘×œ×‘×“');
        return;
      }

      try {
        await addDoc(collection(db, 'teams'), {
          groupId: currentEditingGroupId,
          name: teamName,
          members: members,
          createdAt: new Date().toISOString()
        });

        document.getElementById('teamName').value = '';
        document.getElementById('teamMembers').value = '';
        showToast('×”×§×‘×•×¦×” × ×•×¡×¤×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error adding team:', error);
        showToast('×©×’×™××” ×‘×”×•×¡×¤×ª ×”×§×‘×•×¦×”');
      }
    }

    function renderTasksList() {
      const container = document.getElementById('tasksList');
      
      if (allTasks.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ××©×™××•×ª ×¢×“×™×™×Ÿ. ×”×•×¡×£ ××ª ×”××©×™××” ×”×¨××©×•× ×”!</div>';
        return;
      }

      container.innerHTML = allTasks.map(task => `
        <div class="list-item">
          <div class="list-item-content">
            <div class="list-item-title">${task.name}</div>
            <div class="list-item-desc">${task.description}</div>
          </div>
          <div>
            <button class="action-button" style="margin-left: 10px;" onclick="window.editTask('${task.id}')">×¢×¨×•×š</button>
            <button class="delete-button" onclick="window.deleteTask('${task.id}')">××—×§</button>
          </div>
        </div>
      `).join('');
    }

    function renderGroupsList() {
      const container = document.getElementById('groupsList');
      
      if (allGroups.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ×—×œ×•×§×•×ª ×¢×“×™×™×Ÿ. ×¦×•×¨ ××ª ×”×—×œ×•×§×” ×”×¨××©×•× ×”!</div>';
        return;
      }

      container.innerHTML = allGroups.map(group => {
        const teams = allTeams.filter(t => t.groupId === group.id);
        return `
          <div class="list-item">
            <div class="list-item-content">
              <div class="list-item-title">${group.name}</div>
              <div class="list-item-desc">${teams.length} ×§×‘×•×¦×•×ª</div>
            </div>
            <div>
              <button class="action-button" style="margin-left: 10px;" onclick="window.editGroup('${group.id}', '${group.name}')">×¢×¨×•×š</button>
              <button class="delete-button" onclick="window.deleteGroup('${group.id}')">××—×§</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderTeamsList() {
      const container = document.getElementById('teamsList');
      const teams = allTeams.filter(t => t.groupId === currentEditingGroupId);
      
      if (teams.length === 0) {
        container.innerHTML = '<div class="empty-state">××™×Ÿ ×§×‘×•×¦×•×ª ×‘×—×œ×•×§×” ×–×•. ×”×•×¡×£ ××ª ×”×§×‘×•×¦×” ×”×¨××©×•× ×”!</div>';
        return;
      }

      container.innerHTML = teams.map(team => `
        <div class="list-item">
          <div class="list-item-content">
            <div class="list-item-title">${team.name}</div>
            <div class="list-item-desc">${team.members}</div>
          </div>
          <button class="delete-button" onclick="window.deleteTeam('${team.id}')">××—×§</button>
        </div>
      `).join('');
    }

    window.editGroup = function(groupId, groupName) {
      currentEditingGroupId = groupId;
      document.getElementById('editGroupTitle').textContent = `×¢×¨×™×›×ª ×—×œ×•×§×”: ${groupName}`;
      renderTeamsList();
      showScreen('editGroup');
    }

    window.editTask = function(taskId) {
      const task = allTasks.find(t => t.id === taskId);
      if (!task) return;

      document.getElementById('taskName').value = task.name;
      document.getElementById('taskDesc').value = task.description;
      
      const addBtn = document.getElementById('addTaskBtn');
      addBtn.textContent = '×©××•×¨ ×©×™× ×•×™×™×';
      addBtn.onclick = async () => {
        const name = document.getElementById('taskName').value.trim();
        const description = document.getElementById('taskDesc').value.trim();

        if (!name || !description) {
          showToast('× × ×œ××œ× ××ª ×›×œ ×”×©×“×•×ª');
          return;
        }

        try {
          const docRef = doc(db, 'tasks', taskId);
          await updateDoc(docRef, {
            name: name,
            description: description
          });

          document.getElementById('taskName').value = '';
          document.getElementById('taskDesc').value = '';
          addBtn.textContent = '×”×•×¡×£ ××©×™××”';
          addBtn.onclick = handleAddTask;
          showToast('×”××©×™××” ×¢×•×“×›× ×” ×‘×”×¦×œ×—×”');
        } catch (error) {
          console.error('Error updating task:', error);
          showToast('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”××©×™××”');
        }
      };
      
      showToast('×¢×¨×•×š ××ª ×”××©×™××” ×•×œ×—×¥ ×©××•×¨');
    }

    window.deleteTask = async function(taskId) {
      try {
        await deleteDoc(doc(db, 'tasks', taskId));
        showToast('×”××©×™××” × ××—×§×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error deleting task:', error);
        showToast('×©×’×™××” ×‘××—×™×§×ª ×”××©×™××”');
      }
    }

    window.deleteGroup = async function(groupId) {
      try {
        const teamsToDelete = allTeams.filter(t => t.groupId === groupId);
        
        for (const team of teamsToDelete) {
          await deleteDoc(doc(db, 'teams', team.id));
        }

        await deleteDoc(doc(db, 'groups', groupId));
        showToast('×”×—×œ×•×§×” × ××—×§×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error deleting group:', error);
        showToast('×©×’×™××” ×‘××—×™×§×ª ×”×—×œ×•×§×”');
      }
    }

    window.deleteTeam = async function(teamId) {
      try {
        await deleteDoc(doc(db, 'teams', teamId));
        showToast('×”×§×‘×•×¦×” × ××—×§×” ×‘×”×¦×œ×—×”');
      } catch (error) {
        console.error('Error deleting team:', error);
        showToast('×©×’×™××” ×‘××—×™×§×ª ×”×§×‘×•×¦×”');
      }
    }

    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }

    // Initialize app
    async function init() {
      setupEventListeners();
      await loadAllData();
      setupRealtimeListeners();
    }

    init();
  </script>
 </body>
</html>
